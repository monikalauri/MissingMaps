{% assign lang = page.lang | default: site.default_lang | default: "en" %}
{% assign T = site.data.i18n[lang] | default: {} %}
{% assign items = site.data.menu.main | sort: "weight" %}
{% assign codes = site.languages | default: "en,fr,cs,es" | split: "," %}

<div class="menu-main">
  <ul>
    {% for item in items %}
    {% comment %} translated label (fallback to original name) {% endcomment %}
    {% assign label = T.nav_labels[item.key] | default: item.name %}

    {% comment %} build href with language prefix for local paths {% endcomment %}
    {% assign href = item.url %}
    {% if href and href != "#" and href contains "://" %}
    {# absolute URL: leave as is #}
    {% elsif href == "#" %}
    {# anchor #}
    {% else %}
    {% if lang != site.default_lang %}
    {% assign href = '/' | append: lang | append: item.url %}
    {% endif %}
    {% endif %}

    {% if item.child %}
    {% assign active_parent = false %}
    {% for childitem in item.child %}
    {% if childitem.url == page.url %}{% assign active_parent = true %}{% endif %}
    {% endfor %}

    <li class="menu-item-dropdown menu-item-{{ item.key }}{% if item.url == page.url %} active{% endif %}{% if active_parent %} active{% endif %}">
      <a href="{{ href | relative_url }}">{{ label }} <i class="fa-solid fa-chevron-down"></i></a>

      <div class="dropdown-menu">
        {% for childitem in item.child %}
        {% assign child_href = childitem.url %}
        {% if child_href and child_href != "#" and child_href contains "://" %}
        {% elsif child_href == "#" %}
        {% else %}
        {% if lang != site.default_lang %}
        {% assign child_href = '/' | append: lang | append: childitem.url %}
        {% endif %}
        {% endif %}
        <a href="{{ child_href | relative_url }}" class="dropdown-item {% if childitem.url == page.url %} active{% endif %}">
          {% if childitem.icon %}
          <div class="dropdown-item-icon"><img src="{{ childitem.icon | relative_url }}" /></div>
          {% endif %}
          {% if childitem.icon_darkmode %}
          <div class="dropdown-item-icon icon-invert"><img src="{{ childitem.icon_darkmode | relative_url }}" /></div>
          {% endif %}
          <div class="dropdown-item-content">
            {% assign child_label = childitem.key | default: childitem.name %}
            {% assign child_label = T.nav_labels[child_label] | default: childitem.name %}
            {% if child_label %}<div class="dropdown-item-name">{{ child_label }}</div>{% endif %}
            {% if childitem.description %}<div class="dropdown-item-description">{{ childitem.description }}</div>{%
            endif %}
          </div>
        </a>
        {% endfor %}
      </div>
    </li>

    {% else %}
    <li class="{% if item.url == page.url %}active{% endif %} {% if item.button %}menu-item-button{% endif %}">
      <a href="{{ href | relative_url }}" {% if item.external %}target="_blank" rel="noopener" {% endif %}>{{ label }}</a>
    </li>
    {% endif %}
    {% endfor %}

    <!-- Lang Switcher -->

    {%- assign cur = page.url -%}
    
    {%- comment -%} Normalize current URL by removing any locale prefix (with & without trailing slash) {%- endcomment -%}
    {%- assign codes = site.languages -%}
    {%- if codes == nil or codes == empty -%}
    {%- assign codes = "en,fr,cs,es" | split: "," -%}
    {%- endif -%}
    {%- assign cur_no_locale = cur -%}
    {%- for raw in codes -%}
    {%- assign code = raw | strip | downcase -%}
    {%- assign with_slash = '/' | append: code | append: '/' -%}
    {%- assign without_slash = '/' | append: code -%}
    {%- assign cur_no_locale = cur_no_locale
    | replace_first: with_slash, '/'
    | replace_first: without_slash, '/' -%}
    {%- endfor -%}
    
    <li class="menu-item-dropdown menu-lang-switcher">
        <a class="lang-pill" type="button">
          <img class="lang-icon" src="{{ '/assets/images/icons/menu-globe.svg' | relative_url }}" alt="">
          {{ lang | upcase }}
        </a>
    
        <div class="dropdown-menu">
          {%- for raw in codes -%}
          {%- assign code = raw | strip | downcase -%}
          {%- if code == site.default_lang -%}
          {%- assign switch_href = cur_no_locale -%}
          {%- else -%}
          {%- assign switch_href = '/' | append: code | append: cur_no_locale -%}
          {%- endif -%}
          <div class="dropdown-item-content">
            <a href="{{ switch_href | relative_url }}" class="{% if code == lang %}active{% endif %} dropdown-item">
              {{ code | upcase }}
            </a>
          </div>
          {%- endfor -%}
        </div>
    </li>
    <!-- -->
  </ul>
</div>